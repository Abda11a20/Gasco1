<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم - الطلبات – Gasco</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Font Awesome CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-primary: #f6d55c;
      --brand-secondary: #007BFF;
      --brand-orange-dark: #ff6f00;
      --brand-orange-hover: #e65100;
      --background-dark: #1C2526;
      --background-light: #2A3435;
      --text-dark: #d3d3d3;
      --text-light: #ffffff;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--background-dark);
      color: var(--text-light);
      margin: 0;
      direction: rtl;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* النَبَر */
    header {
      background-color: var(--background-light);
      padding: 20px 40px;
      border-bottom: 2px solid var(--brand-primary);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .logo-img {
      max-width: 100px;
      height: auto;
    }

    .nav-links {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    #languageSwitcher {
      display: flex;
      gap: 10px;
    }

    .lang-btn {
      padding: 8px 16px;
      background-color: var(--background-light);
      border: 2px solid var(--brand-primary);
      color: var(--text-light);
      font-weight: bold;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s, transform 0.2s;
      font-size: 0.9rem;
    }

    .lang-btn:hover, .lang-btn.active {
      background-color: var(--brand-orange-dark);
      color: var(--text-light);
      transform: scale(1.05);
    }

    /* أيقونة العودة للـ Dashboard */
    .dashboard-icon {
      font-size: 1.8rem;
      color: var(--brand-primary);
      cursor: pointer;
      transition: color 0.3s;
    }

    .dashboard-icon:hover {
      color: var(--brand-orange-dark);
    }

    /* تصميم الكونتينر */
    .container {
      max-width: 800px;
      margin: 3rem auto;
      padding: 2rem;
      background: linear-gradient(145deg, var(--background-light), var(--background-dark));
      border: 2px solid var(--brand-primary);
      border-radius: 15px;
      box-shadow: 0 0 .5rem rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(246, 213, 92, 0.3);
    }

    /* العنوان */
    h1 {
      color: var(--brand-primary);
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
      text-align: center;
      margin-bottom: 20px;
    }

    /* تصميم كارد الطلب */
    .order-card {
      background: linear-gradient(145deg, var(--background-dark), var(--background-light));
      border: 1px solid var(--brand-primary);
      border-radius: 10px;
      margin-bottom: 15px;
      padding: 15px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(246, 213, 92, 0.3);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-header h2 {
      margin: 0;
      font-size: 1.2em;
      color: var(--text-light);
    }

    .order-meta {
      font-size: 0.9em;
      color: var(--text-light);
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .products-list {
      margin-top: 10px;
    }

    .product-item {
      border-top: 1px solid var(--brand-primary);
      padding: 5px 0;
      color: var(--text-light);
    }

    /* أزرار */
    .toggle-details, .update-status {
      background: linear-gradient(45deg, var(--brand-orange-dark), var(--brand-primary));
      color: var(--text-light);
      border: none;
      padding: 5px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s, transform 0.2s;
    }

    .toggle-details:hover, .update-status:hover {
      background: linear-gradient(45deg, var(--brand-orange-hover), var(--brand-primary));
      transform: scale(1.05);
    }

    /* قائمة الحالات */
    select.status-select {
      padding: 5px;
      border-radius: 10px;
      border: 1px solid var(--brand-primary);
      background-color: var(--background-light);
      color: var(--text-light);
      transition: border-color 0.3s;
    }

    select.status-select:focus {
      border-color: var(--brand-orange-dark);
      box-shadow: 0 0 5px rgba(246, 213, 92, 0.5);
    }
  </style>
</head>
<body>
  <!-- النَبَر -->
  <header>
    <div class="nav-links d-flex align-items-center">
      <img src="image/logo.jpg" alt="Gasco Logo" class="logo-img me-3">
    </div>
    <div class="dashboard-icon" onclick="location.href='dashboard.html'">
      <i class="fas fa-tachometer-alt"></i>
    </div>
    <div id="languageSwitcher" class="d-flex align-items-center">
      <button onclick="setLanguage('ar')" class="lang-btn me-2" id="btnArabic">العربية</button>
      <button onclick="setLanguage('en')" class="lang-btn" id="btnEnglish">English</button>
    </div>
  </header>

  <!-- قائمة الطلبات -->
  <div class="container">
    <h1 id="pageTitle">الطلبات</h1>
    <div id="orders-container">جارٍ التحميل...</div>
  </div>

  <script>
    // ترجمات اللغة
    const translations = {
      ar: {
        title: "لوحة تحكم - الطلبات - Gasco",
        pageTitle: "الطلبات",
        loadingMessage: "جارٍ التحميل...",
        noOrdersMessage: "لا توجد طلبات حتى الآن.",
        orderLabel: "طلب #",
        userLabel: "المستخدم: ",
        statusLabel: "الحالة: ",
        finalPriceLabel: "السعر النهائي: ",
        paymentMethodLabel: "طريقة الدفع: ",
        addressLabel: "العنوان: ",
        phoneLabel: "، هاتـف: ",
        productsLabel: "المنتجات: ",
        quantityLabel: " - الكمية: ",
        priceLabel: " - السعر: ",
        showDetailsButton: "عرض التفاصيل",
        hideDetailsButton: "إخفاء التفاصيل",
        updateButton: "تحديث",
        statusPending: "pending",
        statusInProgress: "inProgress",
        statusDelivered: "deleverid",
        statusCanceled: "canceled",
        statusRefunded: "refunded",
        loginMessage: "يجب عليك تسجيل الدخول.",
        fetchErrorMessage: "خطأ في جلب الطلبات",
        updateSuccessMessage: "تم تحديث الحالة بنجاح",
        updateErrorMessage: "فشل التحديث: ",
        errorMessage: "حدث خطأ: "
      },
      en: {
        title: "Dashboard - Orders - Gasco",
        pageTitle: "Orders",
        loadingMessage: "Loading...",
        noOrdersMessage: "No orders yet.",
        orderLabel: "Order #",
        userLabel: "User: ",
        statusLabel: "Status: ",
        finalPriceLabel: "Final Price: ",
        paymentMethodLabel: "Payment Method: ",
        addressLabel: "Address: ",
        phoneLabel: ", Phone: ",
        productsLabel: "Products: ",
        quantityLabel: " - Quantity: ",
        priceLabel: " - Price: ",
        showDetailsButton: "Show Details",
        hideDetailsButton: "Hide Details",
        updateButton: "Update",
        statusPending: "pending",
        statusInProgress: "inProgress",
        statusDelivered: "delivered",
        statusCanceled: "canceled",
        statusRefunded: "refunded",
        loginMessage: "You must be logged in.",
        fetchErrorMessage: "Error fetching orders",
        updateSuccessMessage: "Status updated successfully",
        updateErrorMessage: "Update failed: ",
        errorMessage: "An error occurred: "
      }
    };

    function setLanguage(lang) {
      localStorage.setItem('lang', lang);
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

      document.title = translations[lang].title;
      document.getElementById('pageTitle').textContent = translations[lang].pageTitle;

      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      if (lang === 'ar') {
        document.getElementById('btnArabic').classList.add('active');
      } else {
        document.getElementById('btnEnglish').classList.add('active');
      }
    }

    (async function() {
      const container = document.getElementById('orders-container');
      const token = localStorage.getItem('token');
      const lang = localStorage.getItem('lang') || 'ar';
      setLanguage(lang);

      if (!token) {
        alert(translations[lang].loginMessage);
        return location.href = 'login.html';
      }

      // قائمة الحالات المتاحة
      const statuses = ['pending', 'inProgress', 'deleverid', 'canceled', 'refunded'];

      try {
        container.innerText = translations[lang].loadingMessage;

        const res = await fetch('https://gasco.vercel.app/order', {
          headers: { token: token }
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.message || translations[lang].fetchErrorMessage);
        const orders = json.data;

        if (orders.length === 0) {
          container.innerText = translations[lang].noOrdersMessage;
          return;
        }

        container.innerHTML = orders.map(order => `
          <div class="order-card" id="order-${order._id}">
            <div class="order-header">
              <h2>${translations[lang].orderLabel}${order._id.slice(-6)}</h2>
              <button class="toggle-details" data-id="${order._id}">${translations[lang].showDetailsButton}</button>
            </div>
            <div class="order-meta">${translations[lang].userLabel}${order.user.name} (${order.user.email})</div>
            <div class="order-meta">
              ${translations[lang].statusLabel}
              <select class="status-select" data-id="${order._id}">
                ${statuses.map(s => `
                  <option value="${s}" ${s === order.status ? 'selected' : ''}>${translations[lang][`status${s.charAt(0).toUpperCase() + s.slice(1)}`]}</option>
                `).join('')}
              </select>
              <button class="update-status" data-id="${order._id}">${translations[lang].updateButton}</button>
            </div>
            <div class="order-meta">${translations[lang].finalPriceLabel}${order.finalPrice} EGP</div>
            <div class="details" style="display:none; margin-top:10px;">
              <div class="order-meta">${translations[lang].paymentMethodLabel}${order.paymentMethod}</div>
              <div class="order-meta">${translations[lang].addressLabel}${order.address.street}${translations[lang].phoneLabel}${order.address.phone}</div>
              <div class="products-list">
                <strong>${translations[lang].productsLabel}</strong>
                ${order.products.map(p => `
                  <div class="product-item">
                    ${p.name}${translations[lang].quantityLabel}${p.quantity}${translations[lang].priceLabel}${p.price} EGP
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `).join('');

        // أزرار عرض التفاصيل
        document.querySelectorAll('.toggle-details').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const details = document.querySelector(`#order-${id} .details`);
            const show = details.style.display === 'none';
            details.style.display = show ? 'block' : 'none';
            btn.textContent = show ? translations[lang].hideDetailsButton : translations[lang].showDetailsButton;
          });
        });

        // أزرار تحديث الحالة
        document.querySelectorAll('.update-status').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const select = document.querySelector(`#order-${id} .status-select`);
            const newStatus = select.value;
            try {
              const resp = await fetch(`https://gasco.vercel.app/order/${id}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  token: token
                },
                body: JSON.stringify({ status: newStatus })
              });
              const resJson = await resp.json();
              if (!resJson.success) throw new Error(resJson.message);
              alert(translations[lang].updateSuccessMessage);
            } catch (err) {
              alert(translations[lang].updateErrorMessage + err.message);
            }
          });
        });

      } catch (err) {
        container.innerText = translations[lang].errorMessage + err.message;
      }
    })();
  </script>
</body>
</html>